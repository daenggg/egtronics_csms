<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="author" content="">
    <meta name="generator" content="">
    <title>main</title>

    <script type="text/javascript" src="https://code.jquery.com/jquery-latest.min.js"></script>
    <link href="https://kendo.cdn.telerik.com/2020.3.915/styles/kendo.common.min.css" rel="stylesheet" />
    <link href="https://kendo.cdn.telerik.com/2020.3.915/styles/kendo.default.min.css" rel="stylesheet" />
    <script src="https://code.jquery.com/jquery-1.12.3.min.js"></script>
    <script src="../kendo/kendo.all.min.js"></script>
    <script src="../kendo/jszip.min.js"></script>
    <script src="../kendo/cultures/kendo.culture.ko-KR.min.js"></script>
    <!-- Bootstrap core CSS -->
    <link href="../assets/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="../dashboard.css" rel="stylesheet">
    <style>
    </style>
</head>

<body style="background-color: rgb(255, 255, 255)">
    <!-- Header 영역 -->
    <header class="navbar navbar-dark sticky-top flex-md-nowrap p-0 shadow" style="background-color: white;">
        <a class="navbar-brand col-md-3 col-lg-2 me-0 px-3" href="main.html">
            <img src="../assets/brand/eglogo.png" class="img-fluid logo-img" alt="이지트로닉스 로고">
        </a>
        <div class="navbar-nav">
            <button type="button" class="btn btn-dark">
                <a class="nav-link px-3" href="../home/login.html" style="color: white;">로그아웃</a>
            </button>
        </div>
    </header>

    <div class="container-fluid">
        <nav id="navMenu" class="col-md-2 d-md-block sidebar collapse" style="width: 220px;">
            <p>
        </nav>

        <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
            <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                <h1 class="h2">대시보드</h1>
                <div class="btn-toolbar mb-2 mb-md-0">
                </div>
            </div>
            <div id="stationGrid"></div>
            <p></p><a></a>
            <div id="chargerGrid"></div>
            <p></p><a></a>
            <div id="chargingGrid"></div>
        </main>
    </div>
</body>

</html>

<script type="text/javascript" src="../practice.js"></script>
<script>
    $(document).ready(function() {
        var t = sessionStorage.getItem('accessToken');
        var contentData_station = [];
        var contentData_charger = [];
        var contentData_charging = [];

        // sessionStorage에서 'menuData' 키로 저장된 데이터를 가져와 JSON 객체로 파싱
        let retrievedArray = JSON.parse(sessionStorage.getItem('menuData'));
        console.log(retrievedArray);
        
        // 필터링된 네비게이션 항목을 저장할 빈 배열 선언
        var navItems = [];
        // retrievedArray의 각 항목을 순회
        for (var i = 0; i < retrievedArray.length; i++) {
          // 항목의 permit_r가 true이고 useYn이 "Y"인지 확인
            if (retrievedArray[i].permit_r == true && retrievedArray[i].useYn == "Y") {
              // 조건을 만족하는 항목의 menuName을 navItems 배열에 추가
                navItems.push(retrievedArray[i].menuName);
            }
        }
        console.log(navItems);
        // navItems 배열의 각 항목에 대해 반복
        navItems.forEach(item => {
            // navItems[6], [7]을 건너뛰기 위해 체크
            if (item === navItems[6] || item === navItems[7]) {
            return; 
             }

             for(let i = 16; i<=24; i++){
                if(item === navItems[i]) {
                    return;
                }
             }
            const ul = document.createElement('ul');
            const li1 = document.createElement('li');
            const a1 = document.createElement('a');
            a1.textContent = item; // 링크 텍스트 설정
            a1.href = href_link(item); // href 속성 설정
            li1.appendChild(a1);

            if(item === navItems[5]){
                const nestedUl1 = document.createElement('ul');

                const nestedLi1 = document.createElement('li');
                const nestedA1 = document.createElement('a');
                nestedA1.textContent = navItems[6]; // 링크 텍스트 설정
                nestedA1.href = href_link(navItems[6]); // href 속성 설정
                nestedLi1.appendChild(nestedA1);
                nestedUl1.appendChild(nestedLi1);
                li1.appendChild(nestedUl1);

                const nestedLi2 = document.createElement('li');
                const nestedA2 = document.createElement('a');
                nestedA2.textContent = navItems[7]; // 링크 텍스트 설정
                nestedA2.href = href_link(navItems[7]); // href 속성 설정
                nestedLi2.appendChild(nestedA2);
                nestedUl1.appendChild(nestedLi2);
                li1.appendChild(nestedUl1);
            }
            
            for(let i =16; i<=24; i++){
                var j = 1; // 동적변수를 생성하기 위한 인덱스 번호
                var nestedLi = {}; //동적 변수를 담을 빈 객체 생성
                var nestedA = {}; //동적 변수를 담을 빈 객체 생성
            if(item === navItems[15]){
                const nestedUl1 = document.createElement('ul');
                
                nestedLi[`nestedLi${j}`] = document.createElement('li');
                nestedA[`nestedA${j}`] = document.createElement('a');
                nestedA[`nestedA${j}`].textContent = navItems[i]; // 링크 텍스트 설정
                nestedA[`nestedA${j}`].href = href_link(navItems[i]); // href 속성 설정
                nestedLi[`nestedLi${j}`].appendChild(nestedA[`nestedA${j}`]);
                nestedUl1.appendChild(nestedLi[`nestedLi${j}`]);
                li1.appendChild(nestedUl1);
                j++;
            }}
            
            ul.appendChild(li1);
            navMenu.appendChild(ul);
        });

        $.ajax({
            url: reqURL + "/station/info/page/list?page=1&size=10",
            type: "GET",
            dataType: "json",
            contentType: "application/json",
            timeout: 5000, // 타임 아웃 설정
            beforeSend: function(xhr) {
                xhr.setRequestHeader("Authorization", "Bearer " + t);
                xhr.setRequestHeader("menuId", "13");
                xhr.setRequestHeader("permit", "r");
            },
            success: function(data, textStatus, xhr) {
                var content = data.payload.content;
                for (var i = 0; i < content.length; i++) {
                    var Addr = content[i].stationAddrCity + " " + content[i].stationAddrCountry + " " + content[i].stationAddrTown + " " + content[i].stationAddrRoadname;
                    var test = {
                        stationId: content[i].stationId,
                        stationName: content[i].stationName,
                        companyName: content[i].companyName,
                        companyCode: content[i].companyCode,
                        stationAddr: Addr,
                        useYn: content[i].useYn,
                    }
                    contentData_station.push(test);
                }
                $("#stationGrid").kendoGrid({
                    toolbar: [{
                        template: '<a>충전소</a>'
                    }],
                    columns: [{
                            field: 'companyName',
                            title: '사업자 이름',
                            attributes: {
                                "class": "table-cell",
                                style: "text-align: center;"
                            },
                            width: 150
                        },
                        {
                            field: 'stationId',
                            title: '충전소 ID',
                            attributes: {
                                "class": "table-cell",
                                style: "text-align: center;"
                            },
                            width: 130
                        },
                        {
                            field: 'stationName',
                            title: '충전소 이름',
                            attributes: {
                                "class": "table-cell",
                                style: "text-align: center;"
                            },
                            width: 250
                        },
                        {
                            field: 'stationAddr',
                            title: '주소',
                        },
                        //{ field: "stationContractCapacity", title: "수주 용량" },
                        {
                            field: "useYn",
                            title: "사용여부",
                            width: 90,
                        },

                    ],
                    noRecords: true,
                    pageable: true,
                    dataSource: {
                        data: contentData_station,
                        pageSize: 10,
                        scrollable: true,
                        sortable: true,
                        selectable: true,
                        pageable: {
                            input: true,
                        },
                        editable: true,
                        batch: true,
                    }
                });
            },
            error: function(error) {
                alert('실패: ' + error.responseText);
            }
        });

        $.ajax({
            url: reqURL + "/charger/info/page/list?page=1&size=10",
            type: "GET",
            dataType: "json",
            contentType: "application/json",
            timeout: 5000, // 타임 아웃 설정
            beforeSend: function(xhr) {
                xhr.setRequestHeader("Authorization", "Bearer " + t);
                xhr.setRequestHeader("menuId", "14");
                xhr.setRequestHeader("permit", "r");
            },
            success: function(data, textStatus, xhr) {
                var content = data.payload.content;
                for (var i = 0; i < content.length; i++) {
                    var test = {
                        stationId: content[i].stationId,
                        stationName: content[i].stationName,
                        chargerId: content[i].chargerId,
                        chargerName: content[i].chargerName,
                        chargerModelName: content[i].chargerModelName,
                        useYn: content[i].useYn,
                    }
                    contentData_charger.push(test);
                }

                $("#chargerGrid").kendoGrid({
                    toolbar: [{
                        template: '<a>충전기</a>'
                    }],
                    columns: [{
                            field: 'stationName',
                            title: '충전소 이름',
                            attributes: {
                                "class": "table-cell",
                                style: "text-align: center;"
                            },
                            width: 190
                        },
                        {
                            field: 'stationId',
                            title: '충전소 ID',
                            attributes: {
                                "class": "table-cell",
                                style: "text-align: center;"
                            },
                            width: 120
                        },
                        {
                            field: 'chargerName',
                            title: '충전기 이름',
                            attributes: {
                                "class": "table-cell",
                                style: "text-align: center;"
                            },
                            width: 220
                        },
                        {
                            field: 'chargerId',
                            title: '충전기 ID',
                            attributes: {
                                "class": "table-cell",
                                style: "text-align: center;"
                            },
                            width: 110
                        },
                        {
                            field: "chargerModelName",
                            title: "충전기 모델 이름",
                            attributes: {
                                "class": "table-cell",
                                style: "text-align: center;"
                            },
                            width: 190
                        },
                        {
                            field: "useYn",
                            title: "사용여부",
                            width: 100
                        },
                    ],
                    noRecords: true,
                    pageable: true,
                    dataSource: {
                        data: contentData_charger,
                        pageSize: 10,
                        scrollable: true,
                        sortable: true,
                        selectable: true,
                        pageable: {
                            input: true,
                        },
                        editable: true,
                        batch: true,
                    },
                });
            },
            error: function(error) {
                alert('실패: ' + error.responseText);
            }
        });

        $.ajax({
            url: reqURL + "/transaction/info/page/list?page=1&size=50&order=Descending&by=transactionId",
            type: "GET",
            dataType: "json",
            //data : JSON.stringify(data1), //json 데이터
            contentType: "application/json",
            timeout: 5000, // 타임 아웃 설정
            beforeSend: function(xhr) {
                xhr.setRequestHeader("Authorization", "Bearer " + t);
                xhr.setRequestHeader("menuId", "15");
                xhr.setRequestHeader("permit", "r");
            },
            success: function(data, textStatus, xhr) {
                var content = data.payload.content;
                for (var i = 0; i < content.length; i++) {

                    var total_kWh = Wh_JSONformat(content[i].totalChargedWh);
                    var Amount = won_JSONformat(content[i].chargingAmount);
                    var test = {
                        transactionId: content[i].transactionId,
                        stationId: content[i].stationId,
                        chargerId: content[i].chargerId,
                        connectorId: content[i].connectorId,
                        rfCardNo: content[i].rfCardNo,
                        startDt: content[i].startDt,
                        stopDt: content[i].stopDt,
                        totalChargedWh: total_kWh,
                        chargingAmount: Amount,
                    }
                    contentData_charging.push(test);
                }
                $("#chargingGrid").kendoGrid({

                    toolbar: [{
                        template: '<a>충전 정보</a>'
                    }],
                    columns: [{
                            field: 'transactionId',
                            title: '충전 ID',
                            attributes: {
                                "class": "table-cell",
                                style: "text-align: center;"
                            },
                            width: 100
                        },
                        {
                            field: 'stationId',
                            title: '충전소 ID',
                            attributes: {
                                "class": "table-cell",
                                style: "text-align: center;"
                            },
                            width: 120
                        },
                        {
                            field: 'chargerId',
                            title: '충전기 ID',
                            attributes: {
                                "class": "table-cell",
                                style: "text-align: center;"
                            },
                            width: 100
                        },
                        {
                            field: 'connectorId',
                            title: '커넥터 ID',
                            width: 100
                        },
                        {
                            field: "rfCardNo",
                            title: "회원 정보",
                            width: 150
                        },
                        {
                            field: "startDt",
                            title: "충전 시작 날짜",
                            width: 180
                        },
                        {
                            field: "stopDt",
                            title: "충전 종료 날짜",
                            width: 180
                        },
                        {
                            field: "totalChargedWh",
                            title: "충전 전력량",
                            attributes: {
                                "class": "table-cell",
                                style: "text-align: center;"
                            },
                            width: 130
                        },
                        {
                            field: "chargingAmount",
                            title: "충전 금액",
                            width: 110
                        },
                    ],
                    noRecords: true,
                    pageable: true,
                    dataSource: {
                        data: contentData_charging,
                        pageSize: 5,
                        scrollable: true,
                        sortable: true,
                        selectable: true,
                        pageable: {
                            input: true,
                        },
                        editable: true,
                        batch: true,
                    }
                });

            },
            error: function(error) {
                alert('실패: ' + error.responseText);
            }
        });
    });

    function sleep_T(sec) {
        let start = Date.now(),
            now = start;
        while (now - start < sec * 100) {
            now = Date.now();
        }
    }
</script>