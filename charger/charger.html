<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="description" content="">
        <meta name="author" content="">
        <meta name="generator" content="">
        <title>충전기 관리</title>
    
        <script type="text/javascript" src="https://code.jquery.com/jquery-latest.min.js" ></script>
        <link href="https://kendo.cdn.telerik.com/2020.3.915/styles/kendo.common.min.css" rel="stylesheet" />
        <link href="https://kendo.cdn.telerik.com/2020.3.915/styles/kendo.default.min.css" rel="stylesheet" />
        <script src="https://code.jquery.com/jquery-1.12.3.min.js"></script>
        <script src="../kendo/kendo.all.min.js"></script>
        <script src="../kendo/jszip.min.js"></script>
        <script src="../kendo/cultures/kendo.culture.ko-KR.min.js"></script>
        <!-- Bootstrap core CSS -->
        <link href="../assets/dist/css/bootstrap.min.css" rel="stylesheet">
        <link href="../dashboard.css" rel="stylesheet">
        <style>
          
        </style>
      </head>

      <body style="background-color: rgb(255, 255, 255)">
    
        <header class="navbar navbar-dark sticky-top flex-md-nowrap p-0 shadow" style="background-color: white;">
          <a class="navbar-brand col-md-3 col-lg-2 me-0 px-3" href="../main/main.html">
              <img src="../assets/brand/eglogo.png" class="img-fluid logo-img" alt="이지트로닉스 로고">
          </a>
          <div class="navbar-nav">
              <button type="button" class="btn btn-dark">
                  <a class="nav-link px-3" href="../home/login.html" style="color: white;">로그아웃</a>
              </button>
          </div>
      </header>
        
      <div class="container-fluid">
        <nav id="navMenu" class = "side-bar">
            <section class="side-bar__icon-box">
                <section class="side-bar__icon-1">
                  <div></div>
                  <div></div>
                  <div></div>
                </section>
              </section>
            <p>
        </nav>
        
          <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
            <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
              <h1 class="h2">충전기 관리</h1>
            </div>
            <div id="gridDiv"></div>
            <p></p><a></a>
            <p></p><a></a>
            <div id="connectorgrid"></div>
          </main>
        </div>
      </body>
</html>

<script src="../practice.js"></script>
<script >
var connector_contentData = [];
var contentData = [];
var station_Id = null;
var charger_Id = null;

$(document).ready(function () {
  var t = sessionStorage.getItem('accessToken');
  sessionStorage.setItem('chargerId', "");
//  console.log("[accessToken] : " + JSON.stringify(t));
// sessionStorage에서 'menuData' 키로 저장된 데이터를 가져와 JSON 객체로 파싱
let retrievedArray = JSON.parse(sessionStorage.getItem('menuData'));
        console.log(retrievedArray);

        // 필터링된 네비게이션 항목을 저장할 빈 배열 선언
        var navItems = [];
        // retrievedArray의 각 항목을 순회
        for (var i = 0; i < retrievedArray.length; i++) {
        // 항목의 permit_r가 true이고 useYn이 "Y"인지 확인
        if (retrievedArray[i].permit_r === true && retrievedArray[i].useYn === "Y") {
            // 조건을 만족하는 항목의 menuName을 navItems 배열에 추가
            navItems.push(retrievedArray[i].menuName);
        }
        }
        console.log(navItems);

        // navItems 배열의 각 항목에 대해 반복
        navItems.forEach((item, index) => {
        // navItems[6], [7]을 건너뛰기 위해 체크
        if (index === 6 || index === 7) return;

        // navItems[16]~[24]를 건너뛰기 위해 체크
        if (index >= 16 && index <= 24) return;

        const ul = document.createElement('ul');
        const li1 = document.createElement('li');
        const a1 = document.createElement('a');
        a1.textContent = item; // 링크 텍스트 설정
        a1.href = href_link(item); // href 속성 설정
        li1.appendChild(a1);

        // navItems[5]에 대해 2차 메뉴 생성
        if (index === 5) {
            const nestedUl1 = document.createElement('ul');

            // 2차 메뉴 항목 추가
            [6, 7].forEach(subIndex => {
            const nestedLi = document.createElement('li');
            const nestedA = document.createElement('a');
            nestedA.textContent = navItems[subIndex]; // 링크 텍스트 설정
            nestedA.href = href_link(navItems[subIndex]); // href 속성 설정
            nestedLi.appendChild(nestedA);
            nestedUl1.appendChild(nestedLi);
            });

            li1.appendChild(nestedUl1);
        }

        // navItems[15]에 대해 2차 메뉴 생성
        if (index === 15) {
            const nestedUl1 = document.createElement('ul');

            for (let i = 16; i <= 24; i++) {
            const nestedLi = document.createElement('li');
            const nestedA = document.createElement('a');
            nestedA.textContent = navItems[i]; // 링크 텍스트 설정
            nestedA.href = href_link(navItems[i]); // href 속성 설정
            nestedLi.appendChild(nestedA);
            nestedUl1.appendChild(nestedLi);
            }

            li1.appendChild(nestedUl1);
        }

        ul.appendChild(li1);
        navMenu.appendChild(ul);
        });
    
       $.ajax({    			
        url: reqURL+"/charger/info/page/list?page=1&size=1000",
        type: "GET",
        dataType: "json", 
        contentType: "application/json",
        timeout: 5000, // 타임 아웃 설정
        beforeSend: function (xhr) {
            xhr.setRequestHeader("Authorization","Bearer " + t);
            xhr.setRequestHeader("menuId","14");
            xhr.setRequestHeader("permit","r");
        },
        success: function(data, textStatus, xhr) {
          console.log("data"+JSON.stringify(data));
            var content =  data.payload.content;
            for(var i = 0; i < content.length; i ++) {
                var test = 
                {
                  stationId : content[i].stationId,
                  stationName : content[i].stationName,
                  chargerId : content[i].chargerId,
                  chargerName : content[i].chargerName,
                  heartbeatStatus : content[i].heartbeatStatus,
                  chargerModelCode : content[i].chargerModelCode,
                  chargerModelName : content[i].chargerModelName,
                  chargerSerialNumber : content[i].chargerSerialNumber,
                  vendorId : content[i].vendorId,
                  registrationStatus : content[i].registrationStatus,
                  availableStatus : content[i].availableStatus,
                  heartbeatDate : content[i].heartbeatDate,
                  firmwareVersion : content[i].firmwareVersion,
                  localListVersion : content[i].localListVersion,
                  ocppId : content[i].ocppId,
                  ocppPw : content[i].ocppPw,
                  kecoRoamingYn : content[i].kecoRoamingYn,
                  kepcoRoamingYn : content[i].kepcoRoamingYn,
                  chargerGpsX : content[i].chargerGpsX,
                  chargerGpsY : content[i].chargerGpsY,
                  useYn : content[i].useYn,
                  deleteYn : content[i].deleteYn,
                }
                contentData.push(test);
            }
            Maingrid();
        },
        error: function(error) {
            alert('실패: ' + error.responseText);
        }
    });

    $("#connectorgrid").kendoGrid({
      dataBound: dataBound2,
      toolbar: [
      { template:'<a>커넥터 정보</a>'},
      ],
      columns: [
          { field: 'stationId', title: '충전소 ID', attributes: { "class": "table-cell", style: "text-align: center;" },width: 120  },
          { field: 'chargerId', title: '충전기 ID', attributes: { "class": "table-cell", style: "text-align: center;" }, width: 110 },
          { field: "connectorId", title: "커넥터 ID",width: 110  },
          { field: "status", title: "상태정보",width: 130  },
          { field: "statusNotificationDate", title: "상태정보 날짜", width: 190 },
          { field: "errorCode", title: "에러코드", width: 130 },
          { field: "vendorErrorCode", title: "제조사 에러코드",  },
      ],
      noRecords: true,
      scrollable: true,
      sortable: true,
      batch: true,
      selectable: true,
      pageable:true,
      dataSource: {
        data:connector_contentData,
        pageSize: 10,
      filterable: true,
      editable: true,
  },
});});

function Maingrid(){
  $("#gridDiv").kendoGrid({
      dataBound: dataBound,
      columnMenu: {
                    filterable: false
                },
              dataSource: {
                data:contentData,
                pageSize: 10,
                pageable: {
                  input: true,
                },
              filterable: true,
              editable: true,
              },
              noRecords: true,
              scrollable: true,
              sortable: true,
              batch: true,
              selectable: true,
              pageable:true,
      toolbar: [
          { text: "select", template: '<a class="k-button" href="\\#" onclick="return btnChargerInsert()"></span>&nbsp충전기 추가</a>' }, //&nbsp;
          { text: "select", template: '<a class="k-button" href="\\#" onclick="return btnChargerUpdate()"></span>&nbsp충전기 수정</a>' },
      ],
      columns: [
          { field: 'stationName', title: '충전소 이름', attributes: { "class": "table-cell", style: "text-align: center;" }, width: 190},
          { field: 'chargerName', title: '충전기 이름', attributes: { "class": "table-cell", style: "text-align: center;" }, width: 220},
          { field: 'stationId', title: '충전소 ID', attributes: { "class": "table-cell", style: "text-align: center;" }, width: 120},
          { field: 'chargerId', title: '충전기 ID', attributes: { "class": "table-cell", style: "text-align: center;" }, width: 110},
          { field: "ocppId", title: "OCPP ID", attributes: { "class": "table-cell", style: "text-align: center;" },width: 110 },
          { field: "heartbeatStatus", title: "충전기 상태", attributes: { "class": "table-cell", style: "text-align: center;" },width: 120 },
          //{ field: "ocppPw", title: "OCPP PW" },
          { field: "chargerModelName", title: "충전기 모델 이름", attributes: { "class": "table-cell", style: "text-align: center;" }, width: 190},
          { field: "chargerModelCode", title: "충전기 모델 코드",  width: 160},
          { field: "chargerSerialNumber", title: "충전기 시리얼", width: 200 },
          { field: "vendorId", title: "충전기 제조사", width: 140 },
          { field: "firmwareVersion", title: "프로그램 버전", width: 150 },
          { field: "localListVersion", title: "로컬 회원 버전", width: 150 },
          //{ field: "kecoRoamingYn", title: "환경부 로밍 여부", width: 140  },
          //{ field: "kepcoRoamingYn", title: "한전 로밍 여부", width: 140  },
          { field: "registrationStatus", title: "충전기 부팅", width: 150 },
          { field: "availableStatus", title: "충전기 가용여부", width: 150 },
          { field: "heartbeatDate", title: "충전기 정보 전송 일시", width: 190 },
          { field: "chargerGpsX", title: "GPS X", width: 140 },
          { field: "chargerGpsY", title: "GPS Y", width: 140 },
          { field: "useYn", title: "사용여부", width: 100 },
          //{ field: "deleteYn", title: "삭제여부" },

      ],
      
  change: function (e) {
    var grid = $("#gridDiv").data("kendoGrid");
    var DataItem = grid.dataItem(grid.select());
    station_Id = DataItem.stationId;
    charger_Id = DataItem.chargerId;
    callconnector(station_Id, charger_Id);
  }
});
}

function dataBound(e) {
    var _width = 2000;
    var grid_data = $("#gridDiv").data("kendoGrid");

    grid_data.thead.closest('table').width(_width);
    grid_data.tbody.closest('table').width(_width);
}
function dataBound2(e) {
    var _width = 1000;
    var grid_data = $("#connectorgrid").data("kendoGrid");

    grid_data.thead.closest('table').width(_width);
    grid_data.tbody.closest('table').width(_width);
}

function callconnector(station_Id, charger_Id){
 var t = sessionStorage.getItem('accessToken');
       $.ajax({    			
        url: reqURL+"/connector/info/list?stationId=" + station_Id + "&chargerId=" + charger_Id,
        type: "GET",
        dataType: "json", 
        contentType: "application/json",
        timeout: 5000, // 타임 아웃 설정
        beforeSend: function (xhr) {
            xhr.setRequestHeader("Authorization","Bearer " + t);
            xhr.setRequestHeader("menuId","14");
            xhr.setRequestHeader("permit","r");
        },
        success: function(data, textStatus, xhr) {
            var content =  data.payload;
            for(var i = 0; i < content.length; i ++) {
                var test = 
                {
                  stationId : content[i].stationId,
                  chargerId : content[i].chargerId,
                  connectorId : content[i].connectorId,
                  status : content[i].status,
                  statusNotificationDate : content[i].statusNotificationDate,
                  errorCode : content[i].errorCode,
                  vendorErrorCode : content[i].vendorErrorCode,
                }
                connector_contentData.push(test);
            }
            var grid = $("#connectorgrid").data('kendoGrid');           
            grid.dataSource.data([]); 
            grid.setDataSource([]);
            connectorData();
        },
        error: function(error) {
            alert('실패: ' + error.responseText);
        }
    });
 }

function connectorData(){
  
  var dataSource = new kendo.data.DataSource({
        data:connector_contentData,
  });
var grid = $("#connectorgrid").data("kendoGrid");

grid.setDataSource(dataSource);
connector_contentData = [];
}

function btnChargerInsert(){
  window.open("chargerInsert.html", "충전기 등록", "width=600, height=650, top=150, left=200");
}

function btnChargerUpdate(){
  Charger_Check();
  var data = sessionStorage.getItem('chargerId');
  if(data == "" ||data == null){
    alert('수정할 곳을 선택하여 주세요');
  }
  else{
    window.open("chargerUpdate.html", "충전기 수정", "width=600, height=650, top=150, left=200");
  }
}

function Charger_Check(){
  var grid = $("#gridDiv").data("kendoGrid");
  var rows = grid.select();
  var selectedIds = [];

  $(rows).each(function(){
    var dataItem = grid.dataItem(this);
    selectedIds.push(dataItem);
    for(var i in selectedIds) {
      sessionStorage.setItem('chargerId', selectedIds[i].chargerId);
    }
  });
}
  
</script>